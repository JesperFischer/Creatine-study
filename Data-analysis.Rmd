---
title: "Pre-registered randomized double blinded creatine study on recreational climbers"
author: "Jesper Fischer Ehmsen"
date: "`r Sys.Date()`"
output:
  
  html_document: default
  word_document: default
  pdf_document:
    keep_tex: yes
  header-includes:
    \usepackage{table}
    \usepackage{tabular}   
link-citations: yes
linkcolor: blue
csl: nature.csl
---

```{r setup, include=FALSE, eval=TRUE}
library(kableExtra)
library(ppcor)
library(tidyverse)
library(janitor)
#knitr::opts_chunk$set(echo = TRUE)

```


Abstract
===============================================================================



Introduction
==============================================================================
Climbing as a sport has been growing in popularity as a sport in recent years, with its presence seem in the olypmic games 2020. Climbing as a competetive sport invovles many aspect of athletic performance, but descriptive hallmarks of a great climber seems to evovle around great upper body including finger strength compared to the bodyweight of the althlete as well as a relativly low bodyweight (REf,ref,ref).




Methods
===============================================================================


```{r, include=FALSE, eval = T}
source("scripts.R")
data1 = get_data()

```

This project was pre-registered in [osf](https://osf.io/3vf6x) and the methods and statistical analyses are therefore in accordance to the pre-registration unless stated as an exploratory analysis.

#### **Participants**
After given written consent `r length(unique(data$id))` recreational climbers (f = `r data %>% filter(k_n2 == 2) %>% summarize(n = n()/2)`) with `r round(mean(data$klatre_r2,na.rm = T),1)` $\pm$ `r round(sd(data$klatre_r2,na.rm = T),1)` (mean $\pm$ sd) years of climbing experience completed a battery of climbing specific exercises and agreed to turn up the following week the same time of day. Participants were given either pure maltodextrin or a combination of creatine and maltodextrin and were instructed to ingest 7.5grams 4 times a day, as evenly distributed as possible. The creatine arm of the experiment also ingested maltodextrin due to strengthening of the blinding as maltodextrin tastes sweet and creatine monohydrate is flavourless. Exclusion citeria of the current study included (a) not ingesting the powder (b) useage of creatine in the last 6 months (c) training in the last 48 hours up to testing (d) ingestion of alcohol, caffeine or other performance modulating substances in the last 6 hours. Participants in the study (between `r range(data$alder2, na.rm = T)[1]` and `r range(data$alder2, na.rm = T)[2]`) were pseudo-randomly divided into two groups such that each group had similar characteristics (age,physical performance, years of climbing experience, blabllblablalballba), this pseudo randomization was conducted by a third party such that the study was double blinded. The study was conducted in accordance with the Declaration of Helsinki and was approved by the ethics committee of the responsible department.

```{r, include = F, eval=T}
table_general = get_summary_general(data)
table = get_summary(data)
```

```{r, warning = F, message = F, echo = F}
kbl(table_general, caption = "Table 1 descriptive summary of the Placebo (n = 16) and the Creatine (n = 16) group") %>%
  kable_classic()
```

#### **Testing procedure**

Climbers firstly did a 5 minute standardized warm-up, hereafter they went through a battery of 8 strength measuring tests and finally 5 minute testing on a standardized climbing circuit board (moon-board). The battery of strength tests was performed in the following order for all participants. First maximal isometric voluntary contraction (MIVC) of the finger flexors in a crimped position was assessed. After 30 seconds rest maximal number of pull ups were performed, which were defined as chin over the bar and minimal momentum. After a minutes rest the climbers were to hang as long as possible on a 20mm edge in a half crimp position. Next MIVC was measured in a pinch position for both left and right hand. After another minute of rest participants performed the last strength exercise, a 90$^{\circ}$ biceps lock off with a dumbbell. The weight of the dumbbell was determined by the number of pull ups performed on the first testing day (i.e prior to creatine or placebo ingestion), > 10 pull ups was accompanied by a dumbbell weight of 17kg (if this was still to much to be held for less than 5 seconds, 13 kg was used) > 15 pull ups with 21kg and < 15 pull ups with 25kg. After another minutes of rest participants were instructed in climbing on the moon board where five pre-selected climbing rutes were chosen of gradual increase in difficulty, the climbers then had 5 minutes to complete as many of the five climbing rutes or get as far as possible on the first rute.
The testing protocol was performed twice, one in the inital visit and one after a week of creatine or placebo. Due to reported time of day fluctuations of strength, the climbers all completed the second visit within 2 hours of the time the week prior (REF).
To ensure no errors occurred doing counting or timing of participants as well as ensure the same quality of reps on the pre and post sessions as participants were filmed and the videos were afterwards double checked to match with the recorded reps and time. Temperature and humidity was also monitored, when the participants started their session. 


### **Statistical analysis**
All statistical analysis was performed in the statistical programming language R (REF). The analysis of choice to maximize statistical power and minimize the number of statistical tests was a repeated measures MANOVA with all 8 strength tests included as dependent variables. Assumption of univariate normality was assessed using shapiro-Wilks test, assumption of multivariate normality was tested with Mardias test and lastly the assumption of homogeneity of variances and covariances was tested using box's M test (see appendix). 



The sample size of the current study was calculated using the latest meta analysis on the effects of creatine on upper body strength (REF), which indicated that a sample size of 32 was needed to achieve 80% power and $\alpha$ = 0.05.


Results
===============================================================================


```{r, warning = F, message = F, echo = F}
#a = data %>% select(crimphøjremax,crimpvenstremax, pinchhøjremax, pinchvenstremax,pullups_r,lattice_r,ll_r,lr_r)
#corrplot(cor(a,use = "complete.obs"), method = "pie")
```



```{r, include=FALSE, eval = T}
#source("scripts.R")
#data = get_data1()

#uden kropsvægt:
m1 = manova(cbind(crimphøjremax,crimpvenstremax, pinchhøjremax, pinchvenstremax,pullups_r,lattice_r,ll_r,lr_r) ~ 
              tid*gruppe+Error(id),
              data = data)


results = summary(m1)
results


#h3
library(lme4)
summary(lmerTest::lmer(moon.tal ~ gruppe*tid+(1|id), data = data))
```


```{r}
#med kropsvægt:
m1 = manova(cbind(hcbw,vcbw, hpbw, vpbw,pullups_r,lattice_r,llbw, lrbw) ~ 
              tid*gruppe+Error(id),
              data = data)


results = summary(m1)
results


#h3
library(lme4)
summary(lmerTest::lmer(moon.tal ~ gruppe*tid+(1|id), data = data))


```


The main MANOVA analysis showed a main effect of time Pillai = `r round(results$"Error: Within"$stats[1,2],2)`, F = `r round(results$"Error: Within"$stats[1,3],2)` p = `r round(results$"Error: Within"$stats[1,6],2)` however no significant group by time interaction was found Pillai = `r round(results$"Error: Within"$stats[2,2],2)`, F = `r round(results$"Error: Within"$stats[2,3],2)` p = `r round(results$"Error: Within"$stats[2,6],2)`.

\newpage

```{r, warning = F, message = F, echo = F}
kbl(table,caption = "Table 2 \n Intervention effect, one week of either creatine (n = 16) or placebo (n = 16)") %>%
  kable_classic() %>% 
  add_header_above(c(" " = 1, "Placebo" = 2, "Creatine" = 2))
```


Exploratory analysis:
=============================
```{r}
#finger styrke
m1 = manova(cbind(hcbw,vcbw, hpbw, vpbw,lattice_r) ~ 
              tid*gruppe+Error(id),
              data = data)


results = summary(m1)
results

#manova kropsstyrke:
m1 = manova(cbind(pullups_r,llbw, lrbw) ~ 
              tid*gruppe+Error(id),
              data = data)


results = summary(m1)
results

```






```{r, fig.width = 6, fig.height = 5, warning = F, message = F, echo = F, fig.cap = "This is the figure caption to make the space fit"}
#plots
library(ggpol)

newdata <- data[order(data$crimphøjremax),]
data$tid = as.factor(data$tid)

data1 = data %>% mutate(tid = as.numeric(as.character(tid))) %>% mutate(tid2 = ifelse(data$tid == 1, a<-1.25, b<-1.75))

data %>% ggplot(aes(x = tid, y = ll_r))+ 
  geom_boxplot(aes(col = gruppe), outlier.color = NA,width = 0.3)+
  geom_line(data = data1, aes(x = tid2, y = ll_r,group = id, col = gruppe),position=position_dodge(0.1), size = 1.1)+
  geom_point(data = data1, aes(x = tid2, y = ll_r, col = gruppe, group = id), position = position_dodge(0.1), size = 2)+
scale_color_manual(labels=c("no-good-stuff","the good stuff"), values = c("#a9a9a9","#000000"))+scale_x_discrete(" ", breaks = c(1,2), labels = c("pre","post"))+ggtitle("group by time of the good stuff in lock-off on left arm")+ylab("Time (s)")+ theme(plot.title = element_text(hjust = 0.5))#+facet_wrap(~kod, labeller = as_labeller(c("0" = "Ingen kød","1" = "Kød!")))


```



```{r, fig.width = 10, fig.height = 10, warning = F, message = F, echo = F, fig.cap = "This is the figure caption to make the space fit"}
library(corrplot)
data1 = data %>% distinct(id)
a = data[,c(15,17,18,19,20,21,22,23,25,26,27,28,29,30,31,39,44,41,40)]
correlation = pcor(a %>% drop_na())
corrplot(cor(a,use = "complete.obs"), method = "pie")

#partial correlations:
#correlation = pcor(a %>% drop_na())
#corrplot(correlation$estimate, method = "pie",p.mat = correlation$p.value, sig.level = 0.05)
```


```{r, include=F, eval=T}
cor = data %>% group_by(id) %>% summarize(lattice = mean(lattice_r), sportsgrade = mean(sport_grad)) %>% tidyr::drop_na()
cor = cor.test(cor$lattice, cor$sportsgrade)


cor = data %>% group_by(id) %>% summarize(crimphøjremax = mean(crimphøjremax), boldergrade = mean(bouldering_grad)) %>% tidyr::drop_na()
cor = cor.test(cor$crimphøjremax, cor$boldergrade)

```


```{r, fig.width = 6, fig.height = 5, warning = F, message = F, echo = F, fig.cap = "This is the figure caption to make the space fit"}
#correlation between time in lattice and self-reported sports grade:
library(ggtext)
cor = data %>% group_by(id) %>% summarize(lattice = mean(lattice_r), sportsgrade = mean(sport_grad)) %>% tidyr::drop_na()
cor = cor.test(cor$lattice, cor$sportsgrade)

data %>% group_by(id) %>% summarize(lattice = mean(lattice_r), sportsgrade = mean(sport_grad)) %>%  ggplot(aes(y = sportsgrade, x = lattice))+geom_point()+geom_smooth(method = "lm")+theme_classic()+ylab("self reported sports grade")+xlab("Time hung in lattice (s)")+geom_richtext(aes(x = 40, y = 2, label = paste("r = ",round(cor$estimate,2)," ", "[",round(cor$conf.int[1],2),";",round(cor$conf.int[2],2),"], "," p = .01")), size = 5,stat = "unique")

cor = data %>% group_by(id) %>% summarize(crimphøjremax = mean(crimphøjremax), boldergrade = mean(bouldering_grad)) %>% tidyr::drop_na()
cor = cor.test(cor$crimphøjremax, cor$boldergrade)
data %>% group_by(id) %>% summarize(crimphøjremax = mean(crimphøjremax, na.rm = T), boldergrade = mean(bouldering_grad, na.rm = T)) %>% tidyr::drop_na() %>%  ggplot(aes(y = boldergrade, x = crimphøjremax))+geom_point()+geom_smooth(method = "lm")+theme_classic()+ylab("self reported bouldering grade")+xlab("MVC (right) (N)")+geom_richtext(aes(x = 500, y = 2, label = paste("r = ",round(cor$estimate,2)," ", "[",round(cor$conf.int[1],2),";",round(cor$conf.int[2],2),"], "," p > .05")), size = 5,stat = "unique")

```





Discussion
===============================================================================







Appendix
================================
```{r, include = F, eval=T}
#check for univariate normality.
library(rstatix)
data %>% group_by(tid,gruppe) %>%  shapiro_test(crimphøjremax,crimpvenstremax, pinchhøjremax, pinchvenstremax,pullups_r,lattice_r,ll_r,lr_r)

#multivariate normality using Mardia’s Skewness and Kurtosis test,
library(mvnormalTest)
mardia(data[, c("crimphøjremax", "crimpvenstremax","pinchhøjremax","pinchvenstremax","pullups_r","lattice_r","ll_r","lr_r")])$mv.test

##box m test
library(heplots)
boxM(Y = data[, c("crimphøjremax", "crimpvenstremax","pinchhøjremax","pinchvenstremax","pullups_r","lattice_r","ll_r","lr_r")], group = data$tid)
boxM(Y = data[, c("crimphøjremax", "crimpvenstremax","pinchhøjremax","pinchvenstremax","pullups_r","lattice_r","ll_r","lr_r")], group = data$gruppe)


library(rstatix)
# get distance (outlier test:)
mahalanobis_distance(data = data[, c("crimphøjremax", "crimpvenstremax","pinchhøjremax","pinchvenstremax","pullups_r","lattice_r","ll_r","lr_r")])$is.outlier

#correlation-test to see if some are very correlated
cor.test(x = data$pinchhøjremax, y = data$pinchvenstremax, method = "pearson")$estimate
cor.test(x = data$ll_r, y = data$lr_r, method = "pearson")$estimate
cor.test(x = data$lattice_r, y = data$pullups_r, method = "pearson")$estimate

cor.test(x = data$lattice_r, y = data$pullups_r, method = "pearson")$estimate

```




```{r}
library(lme4)
library(ggtext)
#rate of force development:
rofd = read.csv("ROFD_data.csv")
#one participant
rofd$tid = as.factor(rofd$tid)

d1 = rofd %>% filter(participant == "30",test == "ch", tid == "1",testnumber == "1")

df = rofd %>% group_by(participant,test,testnumber,tid) %>% mutate(x = max(tag,na.rm = T))

df$logical = ifelse(df$tag == df$x, a<-TRUE, b<- FALSE)

df = df %>% group_by(participant,test,testnumber,tid) %>% mutate(rækker = 1:n())

df = df %>% group_by(participant,test,testnumber,tid) %>% mutate(aa = min(which(logical == TRUE)))

df$logical = ifelse(df$rækker < df$aa+10, a<-TRUE, b<- FALSE)



library(nlme)
get_parm_nonlin = function(data,testt, testnumberr, tidd){
  p30 = data %>% filter(test == testt,testnumber == testnumberr, logical == TRUE, tid == tidd) %>% drop_na(tag)
  
  p30 %>% ggplot(aes(date, y = tag))+geom_point()+facet_wrap(~participant, ncol = 4)
  
  if(testt == "ch" | testt == "cv"){
    hill_nlme_fit <- nlme::nlme(tag~SSlogis(date,a,b,c), 
                      data = p30,
                      fixed=a+b+c~1, 
                      random = a + b + c ~ 1, 
                      groups = ~ participant, 
                      start = c(Asym = 400,xmid = 1, scal = 0.07),
                      verbose = F,
                      control = nlmeControl(maxIter = 1000, msMaxIter = 1000))
  }else{
    hill_nlme_fit <- nlme::nlme(tag~SSlogis(date,a,b,c), 
                  data = p30,
                  fixed=a+b+c~1, 
                  random = a + b + c ~ 1, 
                  groups = ~ participant, 
                  start = c(Asym = 100,xmid = 0.5, scal = 0.1),
                  verbose = F,
                  control = nlmeControl(maxIter = 1000, msMaxIter = 1000))
    
  }
  
  
  
  summary(hill_nlme_fit)
  
  coef = as_tibble(coef(hill_nlme_fit), rownames = 'participant')
  colnames(coef) = c("id","amplitude","xmid","RFD")
  
  coef$test = testt
  coef$testnumber = testnumberr
  coef$tid = tidd
  
  hill_predtimes <- tidyr::crossing(participant=p30$participant, 
                                date=seq(min(p30$date),
                                    max(p30$date),
                                    length.out=128))
  
  hill_nlmepreds <- hill_predtimes %>% 
    mutate(.fitted=predict(hill_nlme_fit, newdata=hill_predtimes))
  
  plot = ggplot(p30, aes(x=date, y=tag)) +
    geom_point() +
    geom_richtext(aes(x = 3, y = 100, label = paste("Maxcrimp = ", round(x,2))), size = 2.5,stat = "unique")+
    geom_line(data=hill_nlmepreds, aes(y=.fitted), linewidth=0.7) +
    facet_wrap(~participant, ncol=4)

  return(list(coef = coef, plot = plot))
}


ch11 = get_parm_nonlin(df,"ch",1,1)
ch12 = get_parm_nonlin(df,"ch",1,2)
ch21 = get_parm_nonlin(df,"ch",2,1)
ch22 = get_parm_nonlin(df,"ch",2,2)
ch31 = get_parm_nonlin(df,"ch",3,1)
ch32 = get_parm_nonlin(df,"ch",3,2)


ch = rbind(ch11$coef,ch21$coef,ch31$coef)
q = ch %>% dplyr::group_by(id) %>% dplyr::summarize(RFD_ch = max(RFD)) %>% mutate(tid = 1)

ch = rbind(ch12$coef,ch22$coef,ch32$coef)
qq = ch %>% dplyr::group_by(id) %>% dplyr::summarize(RFD_ch = max(RFD)) %>% mutate(tid = 2)

ch = rbind(q,qq)

ch11$plot
ch12$plot
ch21$plot
ch12$plot


cv11 = get_parm_nonlin(df,"cv",1,1)
cv12 = get_parm_nonlin(df,"cv",1,2)
cv21 = get_parm_nonlin(df,"cv",2,1)
cv22 = get_parm_nonlin(df,"cv",2,2)
cv31 = get_parm_nonlin(df,"cv",2,1)
cv32 = get_parm_nonlin(df,"cv",2,2)


cv = rbind(cv11$coef,cv21$coef,cv31$coef)
q = cv %>% dplyr::group_by(id) %>% dplyr::summarize(RFD_cv = max(RFD)) %>% mutate(tid = 1)

cv = rbind(cv12$coef,cv22$coef,cv32$coef)
qq = cv %>% dplyr::group_by(id) %>% dplyr::summarize(RFD_cv = max(RFD)) %>% mutate(tid = 2)

cv = rbind(q,qq)

cv11$plot
cv12$plot
cv21$plot
cv12$plot

cv$tid = as.factor(cv$tid)
ch$tid = as.factor(ch$tid)

rfd = inner_join(cv,ch)

data$id = as.factor(data$id)

data = inner_join(data,rfd)


#N/(S*kg) = RFD/BW
data1 = data %>% group_by(id, tid) %>% dplyr::summarize(RFD_chbw = RFD_ch/BW, RFD_cvbw = RFD_cv/BW) %>% inner_join(data)


m1 = manova(cbind(RFD_cvbw, RFD_chbw) ~ 
              tid*gruppe+Error(id),
              data = data1)

summary(m1)


summary(lmerTest::lmer(RFD_chbw ~ tid*gruppe + (1| id), data = data1))


m1 = manova(cbind(hcbw,vcbw, hpbw, vpbw,pullups_r,lattice_r,llbw, lrbw) ~ 
              tid*gruppe+Error(id),
              data = data1)

summary(m1)


fulldata1 = data1 %>% dplyr::summarize(crimp = mean((hcbw+vcbw)/2, na.rm = T), 
                                                    lockoff = mean((ll_r+lr_r)/2, na.rm = T),
                                                    pinch = mean((hpbw+vpbw)/2, na.rm = T),
                                                    pullups = mean(pullups_r, na.rm = T),
                                                    lattice = mean(lattice_r, na.rm = T),
                                                    RFD = mean((RFD_chbw+RFD_cvbw)/2, na.rm = T),
                                                    moonboard = mean(moon.tal, na.rm = T),
                                                    climbing_experience = klatre_r2,
                                                    ape_idx = mean(span-højde,na.rm = T),
                                       tid = tid,
                                       gruppe = gruppe,
                                       id = id
                                                    )

m1 = manova(cbind(crimp,lockoff, pinch, pullups,lattice,RFD) ~ 
              tid*gruppe+Error(id),
              data = fulldata1)

summary(m1)
```






```{r}
hands = readxl::read_xlsx("Hand measurements.xlsx")
colnames(hands) = c("id","tl","tt","pl","pt","fl","ft","rl","rt","ll","lt")
hands$id = as.factor(hands$id)

hands$tl = as.numeric(hands$tl)
hands$pl = as.numeric(hands$pl)
hands$fl = as.numeric(hands$fl)
hands$rl = as.numeric(hands$rl)
hands$ll = as.numeric(hands$ll)

hands$avg_l = (hands$tl+hands$pl+hands$fl+hands$rl+hands$ll)/5

hands$tt = as.numeric(hands$tt)
hands$pt = as.numeric(hands$pt)
hands$ft = as.numeric(hands$ft)
hands$rt = as.numeric(hands$rt)
hands$lt = as.numeric(hands$lt)

hands$avg_t = (hands$tt+hands$pt+hands$ft+hands$rt+hands$lt)/5


fulldata = inner_join(data, hands)

fulldata = fulldata %>% group_by(id, tid) %>% dplyr::summarize(RFD_chbw = RFD_ch/BW, RFD_cvbw = RFD_cv/BW) %>% inner_join(fulldata)

fulldata1 = fulldata  %>% group_by(id) %>% dplyr::summarize(crimp = mean((hcbw+vcbw)/2, na.rm = T), 
                                                    lockoff = mean((ll_r+lr_r)*vægt/2, na.rm = T),
                                                    pinch = mean((hpbw+vpbw)/2, na.rm = T),
                                                    pullups = mean(pullups_r, na.rm = T),
                                                    lattice = mean(lattice_r, na.rm = T),
                                                    RFD = mean((RFD_chbw+RFD_cvbw)/2, na.rm = T),
                                                    moonboard = mean(moon.tal, na.rm = T),
                                                    climbing_experience = klatre_r2,
                                                    ape_idx = mean(span-højde,na.rm = T)
                                                    )
                                                    


fulldata1 = fulldata1[seq(1,nrow(fulldata1),by = 2), ]

fulldata1$id = NULL

fulldata2 = fulldata1  %>% drop_na()


cor.test(fulldata1$lattice, fulldata1$lockoff)

```


```{r}
library(ppcor)
library(corrplot)
data1 = data %>% distinct(id)
a = data[,c(15,17,18,19,20,21,22,23,25,26,27,28,29,30,31,39,44,41,40)]

fulldata1$id = as.numeric(fulldata1$id)

correlation = pcor(fulldata1 %>% drop_na())

a = fulldata1 %>% drop_na()

library(Hmisc)


corrplot(cor(fulldata1, use = "pairwise.complete.obs"), type = "upper", number.font = 2)

?corrplot()


```

